<!DOCTYPE html>

<html translate="no">

<head>
    <meta charset="utf-8" name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
    <meta name="theme-color" content="#000000">
    <meta name="msapplication-navbutton-color" content="#000000">
    <meta name="apple-mobile-web-app-status-bar-style" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta HTTP-EQUIV="EXPIRES" CONTENT="Mon, 22 Jul 2002 11:12:01 GMT">
    <title>多面投影系統</title>
    <style>
        @charset "UTF-8";
        * {
            /*-moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -o-user-select: none;*/
            -webkit-tap-highlight-color: transparent;
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;
            -webkit-overflow-scrolling: touch;
        }
        html, body, input, button, select, textarea {
            font-family: "Helvetica Neue", Helvetica, Arial, "微軟正黑體", "微软雅黑", "メイリオ", "맑은 고딕", sans-serif;
        }
        #main-title {
            padding-top: 20px;
            padding-bottom: 20px;
            font-size: 30px;
        }
    	body > div {
    		padding: 10px;
    	}
        .title {
        	margin-bottom: 5px;
            font-size: 22px;
        }
        #size .setting {
            margin-top: 5px;
            margin-bottom: 5px;
        }
        #size .value {
            border: 1px solid #EEEEEE;
            padding: 5px;
            font-size: 14px;
        }
        .viewport {
        	margin-bottom: 5px;
        }
        input[type="text"] {
        	width: 60px;
        }
        #wall .ip {
            width: 137px;
        }
        #wall input[type="text"] {
        	margin-left: 2px;
        	margin-right: 7px;
        }
        .preview {
        	width: 100%;
        	background-color: #CCCCCC;
        	min-height: 216px;
        	position: relative;
        	overflow: auto;
        }
        .pivot {
        	position: absolute;
        	top: 0px;
        }
        .pivot .point {
        	left: -10px;
        	top: -10px;
        	width: 20px;
        	height: 20px;
        	border-radius: 100%;
        	background: #FF0000;
        	/*border: 0px solid #000000;*/
        	z-index: 100;
            position: absolute;
        }
        .pivot .single {
            position: absolute;
            background: radial-gradient(circle, rgba(68,68,68,0.5) 0%, rgba(68,68,68,1) 100%);
        }
        .pivot .single > div {
        	position: absolute;
        	/*background-color: #444444;*/
            background: radial-gradient(circle, rgba(68,68,68,0.5) 0%, rgba(68,68,68,1) 100%);
        	/*border: 1px solid #000000;*/
        	overflow: hidden;
        }
        .pivot .single > div > div {
        	/*background-color: #96BA43;*/
            background: radial-gradient(circle, rgba(150,186,67,0.5) 0%, rgba(150,186,67,1) 100%);
        	position: absolute;
            overflow: hidden;
        }
        .pivot .single > div > div > span {
        	position: absolute;
            left: 50%;
            top: 50%;
            -ms-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
            color: #FFFFFF;
            width: 100%;
            text-align: center;
        }
        #file .url {
        	width: 100%;
        	overflow: auto;
        	margin-bottom: 5px;
        }
        #file .name {
            width: 110px;
        }
        #file button {
            margin-bottom: 5px; 
        }
        #file textarea {
            width: 100%;
            font-size: 14px;
        }
        #logo {
            top: 20px;
            right: 20px;
            position: fixed;
            padding-top: 2px;
            padding-bottom: 4px;
            padding-left: 12px;
            padding-right: 12px;
            border: 1px solid #000000;
            background-color: rgba(255, 255, 255, 0.5);
            pointer-events: none;
            -ms-transform-origin: 100% 0%;
            -ms-transform: scale(0.8);
            transform-origin: 100% 0%;
            transform: scale(0.8);
        }
        #logo > div {
            text-align: center;
            padding: 2px;
            font-size: 16px;
        }
        #logo > .english {
            font-size: 10px;
        }
    </style>
    <script src="jquery-3.4.1.min.js?decache=20200410"></script>
    <script>
        function encode(unencoded) {
            return encodeURIComponent(String(unencoded)).replace(/'/g, "%27").replace(/"/g, "%22");  
        }
        function decode(encoded) {
            return decodeURIComponent(String(encoded).replace(/\+/g, " "));
        }
        var setting = {
            room: {
                length: 400, width: 400, height: 400
            },
            location: {
                x: 0, y: 0, z: 160
            },
            setting: {
                single: {
                    enabled: false, x: 0, y: 0, width: 1920, height: 1080
                },
                invert: false,
                mesh: false
            },
            plane: {
                left: {
                    enabled: true,
                    ip: '127.0.0.1',
                    window: {
                        x: 0, y: 360, width: 360, height: 360
                    },
                    viewport: {
                        x: 0, y: 0, width: 360, height: 360
                    }
                },
                front: {
                    enabled: true,
                    ip: '127.0.0.1',
                    window: {
                        x: 360, y: 360, width: 360, height: 360
                    },
                    viewport: {
                        x: 0, y: 0, width: 360, height: 360
                    }
                },
                right: {
                    enabled: true,
                    ip: '127.0.0.1',
                    window: {
                        x: 720, y: 360, width: 360, height: 360
                    },
                    viewport: {
                        x: 0, y: 0, width: 360, height: 360
                    }
                },
                back: {
                    enabled: true,
                    ip: '127.0.0.1',
                    window: {
                        x: 1080, y: 360, width: 360, height: 360
                    },
                    viewport: {
                        x: 0, y: 0, width: 360, height: 360
                    }
                },
                top: {
                    enabled: true,
                    ip: '127.0.0.1',
                    window: {
                        x: 360, y: 0, width: 360, height: 360
                    },
                    viewport: {
                        x: 0, y: 0, width: 360, height: 360
                    }
                },
                bottom: {
                    enabled: true,
                    ip: '127.0.0.1',
                    window: {
                        x: 360, y: 720, width: 360, height: 360
                    },
                    viewport: {
                        x: 0, y: 0, width: 360, height: 360
                    }
                }
            },
            file: ""
        };
        var urlString = '';
        (function() {
            var urlSite = String(document.URL).split('?');
            urlString = urlSite[0];
            var urlData = {};
            if (urlSite[1]) {
                var varGroup = urlSite[1].split('&');
                for (var i in varGroup)
                    urlData[String(varGroup[i].split('=')[0]).toLowerCase()] = varGroup[i].split('=')[1];
            }
            if(urlData.data) {
                var data = null;
                try {
                    data = JSON.parse(decode(urlData.data));
                } catch (error) {
                    data = null;
                }
                if(data) {
                    //setting = data;
                    for(var i in setting) {
                        if(data[i] === undefined) continue;
                        if(typeof setting[i] == 'object') {
                            for(var i2 in setting[i]) {
                                if(data[i][i2] === undefined) continue;
                                if(typeof setting[i][i2] == 'object') {
                                    for(var i3 in setting[i][i2]) {
                                        if(data[i][i2][i3] === undefined) continue;
                                        if(typeof setting[i][i2][i3] == 'object') {
                                            for(var i4 in setting[i][i2][i3]) {
                                                if(data[i][i2][i3][i4] === undefined) continue;
                                                setting[i][i2][i3][i4] = data[i][i2][i3][i4];
                                            }
                                        } else setting[i][i2][i3] = data[i][i2][i3];
                                    }
                                } else setting[i][i2] = data[i][i2];
                            }
                        } else setting[i] = data[i];
                    }
                }
            }
        })();
        Date.prototype.yyyymmdd = function() {
        var mm = this.getMonth() + 1; // getMonth() is zero-based
        var dd = this.getDate();
        return [this.getFullYear(),
              (mm > 9 ? '' : '0') + mm,
              (dd > 9 ? '' : '0') + dd
             ].join('');
        };
        $(function() {
            $('#wall>div').not('.title').append([
            	//'<input checked type="checkbox">前',
                '<div>ip位址<input type="text" class="ip"></div>',
            	'<div class="window">',
            		'視窗 ',
            		'x<input type="text" class="x" value="0">',
            		'y<input type="text" class="y" value="0">',
            		'寬<input type="text" class="width" value="1920">',
            		'高<input type="text" class="height" value="1080">',
            	'</div>',
            	'<div class="viewport">',
            		'畫面 ',
            		'x<input type="text" class="x" value="0">',
            		'y<input type="text" class="y" value="0">',
            		'寬<input type="text" class="width" value="1920">',
            		'高<input type="text" class="height" value="1080">',
            	'</div>'
            ].join(''));
            //
            for(var i in setting.room)
                $('#size input.' + i).val(setting.room[i]);
            for(var i in setting.location)
                $('#location input.' + i).val(setting.location[i]);
            for(var i in setting.setting.single) {
                var value = setting.setting.single[i];
                if(i == 'enabled') $('#single .window input').prop('checked', value);
                else $('#single .window input.' + i).val(value);
            }
            $('#single .invert input').prop('checked', setting.setting.invert);
            $('#single .mesh input').prop('checked', setting.setting.mesh);
            for(var i in setting.plane) {
                var plane = setting.plane[i];
                for(var i2 in plane) {
                    if(i2 == 'enabled')
                        $('#wall .' + i + ' input[type=checkbox]').prop('checked', plane[i2]);
                    else if(i2 == 'ip')
                        $('#wall .' + i + ' .' + i2).val(plane[i2]);
                    else for(var i3 in plane[i2])
                        $('#wall .' + i + ' .' + i2 + ' input.' + i3).val(plane[i2][i3]);
                }
            }
            $('#file .name').val(setting.file || ('setting' + new Date().yyyymmdd()));
            //
            var wall = [];
            function preview() {
                var single = $('#single .window input').prop('checked');
                $('#single .window input[type=text]').each(function() {
                    this.disabled = !single;
                });
                /*$('#wall .window input').each(function() {
                    this.disabled = single;
                });*/
                //
                var zoom = 0.2;
            	wall = [];
                var singleX = single ? (parseFloat($('#single .x').val()) || 0) * zoom : 0;
                var singleW = single ? (parseFloat($('#single .width').val()) || 0) * zoom : 0;
                var singleY = single ? (parseFloat($('#single .y').val()) || 0) * zoom : 0;
                var singleH = single ? (parseFloat($('#single .height').val()) || 0) * zoom : 0;
                //
                var haveFront = false;
            	var minX = single ? Math.min(0, singleX) : 0;
            	var maxX = single ? Math.max(0, singleX + singleW) : 0;
            	var minY = single ? Math.min(0, singleY) : 0;
            	var maxY = single ? Math.max(0, singleY + singleH) : 0;
                $('.pivot').html('<div class="point"></div><div class="single"></div>');
	            $('#wall>div').not('.title').each(function(i2) {
	            	var me = this;
                    var enabled = $(this).children('input').prop('checked');
                    $(me).find('.window input').each(function() {
                        this.disabled = single || !enabled;
                    });
                    $(me).find('.ip').each(function() {
                        this.disabled = single || !enabled;
                    });
                    $(me).find('.viewport input').each(function() {
                        this.disabled = !enabled;
                    });
		            function get(type, viewport) {
		            	return parseFloat($(me).find('.' + (viewport ? 'viewport' : 'window')).children('.' + type).val()) || 0;//) / 5;
		            }
	            	if(enabled) {
                        var name = $(this).children('span').text();
	            		var win = {
            				x: get('x', single),
            				y: get('y', single),
            				w: get('width', single),
            				h: get('height', single)
            			};
            			var x = win.x * zoom;
	            		var y = win.y * zoom;
	            		var w = win.w * zoom;
	            		var h = win.h * zoom;
                        if(!single) {
    	            		minX = Math.min(minX, x);
    	            		minY = Math.min(minY, y);
    	            		maxX = Math.max(maxX, x + w);
    	            		maxY = Math.max(maxY, y + h);
                        }
	            		var dom = $('<div style="left:' + x + 'px;top:' + y + 'px;width:' + w + 'px;height:' + h + 'px;"></div>');
	            		$('.pivot>.single').append(dom);
	            		var view = {
	            			x: /*single ? 0 : */get('x', true),
            				y: /*single ? 0 : */get('y', true),
            				w: get('width', true),
            				h: get('height', true)
	            		};
            			x = single ? 0 : view.x * zoom;
	            		y = single ? 0 : view.y * zoom;
	            		w = view.w * zoom;
	            		h = view.h * zoom;
	            		dom.append('<div style="left:' + x + 'px;top:' + y + 'px;width:' + w + 'px;height:' + h + 'px;"><span>' + name + '<br/>' + view.w + 'x' + view.h + '</span></div>');
	            		//紀錄
	            		var data = {
                            ip: $(me).find('.ip').val(),
                            win: win,
                            view: view,
                            name: name,
                            index: i2
                        };
                        if(i2 == 1) {
                            haveFront = true;
                            data.master = true;
                        }
	            		for(var i in this.dataset)
	            			data[i] = this.dataset[i];
	            		wall.push(data);
	            	}
	            	//console.warn($(this).children('input').prop('checked'));
	            });
	            $('.pivot').css({
	            	left: (-minX) + 'px',
	            	top: (-minY) + 'px'
	            });
                $('.pivot .single').css({
                    left: singleX + 'px',
                    top: singleY + 'px',
                    width: singleW + 'px',
                    height: singleH + 'px',
                    overflow: single ? 'hidden' : 'visible'
                });
	            $('.range').width(maxX - minX).height(maxY - minY);
                if(!haveFront && wall[0]) wall[0].master = true;
	            //console.log(wall);
            }
            function makeFile() {
                function get(selector) {
                    var value = $(selector).val();
                    return parseFloat(value) || 0;
                }
                var single = $('#single .window input').prop('checked');
                var invert = $('#single>.invert>input').prop('checked');
                var mesh = $('#single>.mesh>input').prop('checked');
            	var length = get('#size .length');
                var width = get('#size .width');
                var height = get('#size .height');
            	var config = [
            		'[info] version="23"',
            		//'',
            		(function() {
            			var data = '';
                        if(single) {
                            var x = get('#single .x');
                            var y = get('#single .y');
                            var w = get('#single .width');
                            var h = get('#single .height');
                            var viewport = [];
                            wall.forEach(function(e) {
                                viewport.push(e.viewport);
                            });
                            data = [
                                '',
                                '#主視窗',
                                '[cluster_node] id="node_front" addr="127.0.0.1" window="wnd_all" master="true" sound="true"',
                                '[window] id="wnd_all" viewports="' + viewport.join(',') + '" fullscreen="false" WinX="' + x + '" WinY="' + y + '" ResX="' + w + '" ResY="' + h + '"',
                                ''
                            ].join('\n');
                        }
		            	wall.forEach(function(e) {
                            data += '\n#' + e.name + '\n';
                            if(!single)
                                data += [
                                    '[cluster_node] id="' + e.node + '" addr="' + e.ip + '" window="' + e.window + '"' + (e.master ? ' master="true" sound="true"' : ''),
                                    '[window] id="' + e.window + '" viewports="' + e.viewport + '" fullscreen="false" WinX="' + e.win.x + '" WinY="' + e.win.y + '" ResX="' + e.win.w + '" ResY="' + e.win.h + '"',
                                    ''
                                ].join('\n');
		            		data += [
                                '[viewport] id="' + e.viewport + '" x="' + e.view.x + '" y="' + e.view.y + '" width="' + e.view.w + '" height="' + e.view.h + '" projection="' + e.project + '"',
		            			'[projection] id="' + e.project + '" type="' + (mesh ? 'mesh"' : 'simple" screen="' + e.screen + '"'),
                                ''
		            		].join('\n');
                            if(!mesh) {
                                var l = length / 100;
                                var w = width / 100;
                                var h = height / 100;
                                var screen = '[screen] id="' + e.screen + '" ';
                                switch(e.index) {
                                    case 0:
                                    screen += 'loc="X=0,Y='+(-w/2)+',Z='+(h/2)+'" rot="P=0,Y='+(invert?'':'-')+'90,R=0" size="X='+l+',Y='+h+'"';
                                    break;
                                    case 1:
                                    screen += 'loc="X='+(l/2)+',Y=0,Z='+(h/2)+'" rot="P=0,Y='+(invert?'18':'')+'0,R=0" size="X='+w+',Y='+h+'"';
                                    break;
                                    case 2:
                                    screen += 'loc="X=0,Y='+(w/2)+',Z='+(h/2)+'" rot="P=0,Y='+(invert?'-':'')+'90,R=0" size="X='+l+',Y='+h+'"';
                                    break;
                                    case 3:
                                    screen += 'loc="X='+(-l/2)+',Y=0,Z='+(h/2)+'" rot="P=0,Y='+(invert?'':'18')+'0,R=0" size="X='+w+',Y='+h+'"';
                                    break;
                                    case 4:
                                    screen += 'loc="X=0,Y=0,Z='+h+'" rot="P='+(invert?'-':'')+'90,Y=0,R=0" size="X='+w+',Y='+l+'"';
                                    break;
                                    case 5:
                                    screen += 'loc="X=0,Y=0,Z=0" rot="P='+(invert?'':'-')+'90,Y=0,R=0" size="X='+w+',Y='+l+'"';
                                    break;
                                }
                                data += screen + '\n';
                            }
                            //data += '\n';
		            	});
		            	return data;
            		})(),
					'[camera] id="camera_static" loc="X=' + (get('#location .x') / 100) + ',Y=' + (get('#location .y') / 100) + ',Z=' + (get('#location .z') / 100) + '" eye_swap="false" eye_dist="0.064" force_offset="0"',
					'',
					'[input] id=ControlKeyboard type=keyboard addr=Keyboard0@127.0.0.1 reflect=ue4',
					'',
					'[general] swap_sync_policy="1"',
					'',
					'[network] cln_conn_tries_amount="10" cln_conn_retry_delay="1000" game_start_timeout="30000" barrier_wait_timeout="5000"',
            	    '',
                    '[custom] SampleArg1="SampleVal1" SampleArg2="SampleVal2"'
                ];
            	$('textarea').val(config.join('\n'));
                $('#size .value').text('-size=(' + length + ',' + width + ',' + height + ')');
            }
            function setURL() {
                function get(selector) {
                    var value = $(selector).val();
                    return parseFloat(value) || 0;
                }
                for(var i in setting.room)
                    setting.room[i] = get('#size input.' + i);
                for(var i in setting.location)
                    setting.location[i] = get('#location input.' + i);
                for(var i in setting.setting.single)
                    if(i == 'enabled') setting.setting.single[i] = $('#single .window input').prop('checked');
                    else setting.setting.single[i] = get('#single .window input.' + i);
                setting.setting.invert = $('#single .invert input').prop('checked');
                setting.setting.mesh = $('#single .mesh input').prop('checked');
                for(var i in setting.plane) {
                    var plane = setting.plane[i];
                    for(var i2 in plane) {
                        if(i2 == 'enabled')
                            setting.plane[i][i2] = $('#wall .' + i + ' input[type=checkbox]').prop('checked');
                        else if(i2 == 'ip')
                            setting.plane[i][i2] = $('#wall .' + i + ' .' + i2).val();
                        else for(var i3 in plane[i2])
                            setting.plane[i][i2][i3] = get('#wall .' + i + ' .' + i2 + ' input.' + i3);
                    }
                }
                setting.file = $('#file .name').val();
                var url = urlString + '?data=' + encode(JSON.stringify(setting));//(input ? '?' + input : '');
                $('.url').html('<a href="' + url + '">' + url + '</a>');
            }
            $('input').change(function() {
                if(!$(this).parents('#file')[0]) {
                	if(!$(this).parents('#size')[0]) preview();
                	makeFile();
                }
                setURL();
            });
            preview();
            makeFile();
            setURL();
            //
            function download(filename, text) {
                var element = document.createElement('a');
                element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
                element.setAttribute('download', filename);
                element.style.display = 'none';
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
            }
            $('button').click(function() {
                //var date = new Date();
                download(($('#file .name').val() || '未命名') + '.cfg', $('textarea').val());
            });
        });
    </script>
</head>

<body>
	<div id="main-title">多面投影系統</div>
	<div id="size">
		<div class="title">房間尺寸</div>
	    <div>長(前後) <input type="text" class="length" value="400">公分</div>
	    <div>寬(左右) <input type="text" class="width"  value="400">公分</div>
	    <div>高(上下) <input type="text" class="height" value="400">公分</div>
        <div class="setting">設定值</div>
        <span class="value"></span>
    </div>
    <div id="location">
        <div class="title">起始位置</div>
        <div>x(前後) <input type="text" class="x" value="0">公分</div>
        <div>y(左右) <input type="text" class="y" value="0">公分</div>
        <div>z(高度) <input type="text" class="z" value="160">公分</div>
    </div>
    <div id="single">
        <div class="title">投影設定</div>
        <div class="window">
            <input type="checkbox">
            <span>合併成單一視窗 </span>
            x<input type="text" class="x" value="0">
            y<input type="text" class="y" value="0">
            寬<input type="text" class="width" value="1920">
            高<input type="text" class="height" value="1080">
        </div>
        <div class="invert">
            <input type="checkbox">
            <span>反轉平面(用於大樓外牆)</span>
        </div>
        <div class="mesh">
            <input type="checkbox">
            <span>投影到模型上(由Blueprint設定)</span>
        </div>
    </div>
	<div id="wall">
		<div class="title">投影面</div>
	    <div class="left" data-node="node_left" data-window="wnd_left" data-viewport="vp_left" data-project="proj_simple_left" data-screen="scr_left">
            <input checked type="checkbox">
            <span>左</span>
        </div>
	    <div class="front" data-node="node_front" data-window="wnd_front" data-viewport="vp_front" data-project="proj_simple_front" data-screen="scr_front">
            <input checked type="checkbox">
            <span>前</span>
        </div>
	    <div class="right" data-node="node_right" data-window="wnd_right" data-viewport="vp_right" data-project="proj_simple_right" data-screen="scr_right">
            <input checked type="checkbox">
            <span>右</span>
        </div>
	    <div class="back" data-node="node_back" data-window="wnd_back" data-viewport="vp_back" data-project="proj_simple_back" data-screen="scr_back">
            <input checked type="checkbox">
            <span>後</span>
        </div>
	    <div class="top" data-node="node_ceiling" data-window="wnd_ceiling" data-viewport="vp_ceiling" data-project="proj_simple_ceiling" data-screen="scr_ceiling">
            <input checked type="checkbox">
            <span>上</span>
        </div>
	    <div class="bottom" data-node="node_floor" data-window="wnd_floor" data-viewport="vp_floor" data-project="proj_simple_floor" data-screen="scr_floor">
            <input checked type="checkbox">
            <span>下</span>
        </div>
	</div>
	<div id="preview">
		<div class="title">預覽</div>
	    <div class="preview">
	    	<div class="range"></div>
	    	<div class="pivot"></div>
	    </div>
	</div>
	<div id="file">
		<div class="title">設定檔</div>
		<div class="url"></div>
        <div>
            <div>檔名</div>
            <input type="text" class="name">.cfg
            <button>下載設定檔</button>
        </div>
		<textarea class="config" rows="40"></textarea>
	</div>
    <div id="logo">
        <div>光陣三維</div>
        <div class="english">LightMatrix</div>
    </div>
</body>

</html>